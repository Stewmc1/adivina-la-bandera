import { HttpClient } from '@angular/common/http';
import { Component } from '@angular/core';
import * as countriesData from '../assets/countries.json';
import { CommonModule } from '@angular/common';

export interface PaisDto {
  flags: {
    png: string;
    svg: string;
    alt: string;
  };
  name: {
    common: string;
    official: string;
    nativeName: {
      ara?: {
        official: string;
        common: string;
      };
    };
  };
  capital: string[];
  region: string;
  estado?: string;
}

@Component({
  selector: 'app-jugable',
  imports: [CommonModule],
  templateUrl: './jugable.component.html',
  styleUrl: './jugable.component.css',
})
export class JugableComponent {
  data: PaisDto[] = (countriesData as any).default; //Todos los paises
  opciones: PaisDto[] = []; //Opciones
  opcionCorrecta!: PaisDto; //Bandera que se muestr
  respuestasCorrectas = 0; //Numero de respuestas correctas
  seleccionoRespuesta = false; //Indicia si ya eligio una respuesta
  juegoTerminado = false; //Indica si ya se jugaron todas las banderas
  totalJugadas = 0; //Contador de cuantas se van jugando
  totalBanderas = this.data.length; //Total de banderas

  constructor() {}
ngOnInit() {
    this.data.forEach((pais: PaisDto) => {
      pais.contadorApariciones = pais.contadorApariciones ?? 0;
    });
    this.seleccionarOpciones();
  }

  //Si ya se jugaron todas las banderas
  seleccionarOpciones() {
    if (
      this.jugadas.size === this.data.length &&
      this.data.every(pais => pais.contadorApariciones >= 2)) {
      this.juegoTerminado = true;
      return;
    }

    //Reinicia el estado en cada ronda
    this.opciones.forEach((opcion) => delete opcion['estado']);

    //Reinicia el estado del juego
    this.seleccionoRespuesta = false;

    //Filtra paises no jugados
    const seleccionables = this.data.filter(pais => pais.contadorApariciones < 2);
    const shuffled = [...seleccionables].sort(() => Math.random() - 0.5);

    //Selecciona 4 opciones y una de ellas correcta
    this.opciones = shuffled.slice(0, 4);
    this.opcionCorrecta =
      this.opciones[Math.floor(Math.random() * this.opciones.length)];

    //Marca la opcion correcta como jugada
    this.jugadas.add(this.opcionCorrecta.name.common);
    this.opcionCorrecta.contadorApariciones++;

    //Actualiza el contador
    this.totalJugadas = this.jugadas.size;
